input {
  pipeline {
    address => "audit-sudo-pipeline-kafka"
  }
}

filter {
  
  # í•„ìš”ì—†ëŠ” ë°ì´í„°ë“¤ì€ ëª¨ë‘ drop
  if [auditd][summary][actor][primary] == "unset" or [auditd][data][tty] == "(none)" or [process][title] in ["(pager)", "bash", "groups", "/bin/sh /usr/bin/lesspipe", "basename /usr/bin/lesspipe", "dirname /usr/bin/lesspipe", "dircolors -b", "clear"]{
    drop{}
  }
  else if [process][title] =~ "uname"{
    drop{}
  }
  else if [auditd][message_type] != "syscall" and [auditd][data][syscall] != "execve"{
    drop{}
  }
  else if [user][effective][name] != "root" and ([auditd][summary][actor][primary] != "root" and [auditd][summary][actor][secondary] != "root"){
    drop{}
  }
  else{

    mutate{
    # ë³µìž¡í•œ í•„ë“œ ì´ë¦„ì„ ê°„ë‹¨í•œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
      rename => {
        "[host][ip]" => "ip"
        "[host][name]" => "hostname"
        "[auditd][data][tty]" => "tty"
        "[process][title]" => "command"
        "[auditd][session]" => "ses"
        "[auditd][summary][actor][primary]" => "user"
        "[auditd][summary][actor][secondary]" => "user-permission"
        "[process][working_directory]" => "pwd"
      }
    }

		# ip í•„ë“œê°€ ë°°ì—´ì¼ ê²½ìš° (10.*, 192.*)ë§Œ í•„í„°ë§ -> ë‹¤ë¥¸ ë¶ˆí•„ìš”í•œ IP ì£¼ì†ŒëŠ” ì œì™¸í•˜ê¸° ìœ„í•´ì„œ
    ruby {
        code => "
          if event.get('ip') && event.get('ip').is_a?(Array)
            ips = event.get('ip').select { |ip| ip.start_with?('10.', '192.') }
            event.set('ip', ips)
          end
        "
    }
    
     # ì§€ì •ëœ í•„ë“œë§Œ ìœ ì§€í•˜ê³  ë¶ˆí•„ìš”í•œ í•„ë“œëŠ” ëª¨ë‘ ì œê±°
    prune {
      interpolate => true
      whitelist_names => ["@timestamp", "hostname", "user", "tty", "pwd", "user-permission", "command", "ip", "ses"]

    }
		
		# Discordë¡œ ë³´ë‚¼ message ì„¤ì •
    mutate {
      add_field => { "message" => "
ðŸ“‹ Command Log
ðŸ•’ Timestamp       : %{@timestamp}
ðŸ‘¤ User            : (%{user}) (%{user-permission})
ðŸ’» Hostname        : %{hostname} ([%{ip}])
ðŸ“‚ Working Dir     : %{pwd}
ðŸ“œ Command         : %{command}
ðŸ–¥ï¸ TTY             : %{tty}
ðŸ†” Session ID      : %{ses}
" }
    }
  }

}

output {
  stdout {
    codec => rubydebug
  }
  # Discord Webhookìœ¼ë¡œ ì „ì†¡
  http {
      url => ""
      http_method => "post"
      content_type => "application/json"
      format => "json"
      headers => ["Content-Type", "application/json"]
      mapping => ["content", "%{message}"]
    }

  # ì²˜ë¦¬ëœ ë¡œê·¸ë¥¼ Elasticsearchì— ì €ìž¥
  elasticsearch {
    hosts => ["http://localhost:9200"]
    index => "auditbeat-sudo-logs-%{+YYYY.MM.dd}"
  }
}


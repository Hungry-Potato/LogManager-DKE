input {
  pipeline {
    address => "audit-login-pipeline-kafka"
  }
}

filter {
  # ë¡œê·¸ì¸ì— ì‹¤íŒ¨í•œ ë¡œê·¸ì´ë©´---------------------------------------------------------
  if [auditd][message_type] == "user_login" and [auditd][result] == "fail" {
    mutate {
      # ë³µìž¡í•œ í•„ë“œ ì´ë¦„ì„ ê°„ë‹¨í•œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
      rename => {
        "[auditd][message_type]" => "status"
        "[auditd][data][acct]" => "login_id"
        "[host][name]" => "hostname"
        "[source][ip]" => "source_ip"
        "[auditd][data][terminal]" => "method"
        "[auditd][result]" => "result"
        "[host][ip]" => "ip"
      }
    }

    # ë¡œê·¸ì¸ IDê°€ checkdownì¸ ê²½ìš° ì œê±°
    if [login_id] == "checkdown" {
      drop{}
    }

    # ip í•„ë“œê°€ ë°°ì—´ì¼ ê²½ìš° (10.*, 192.*)ë§Œ í•„í„°ë§ -> ë‹¤ë¥¸ ë¶ˆí•„ìš”í•œ IP ì£¼ì†ŒëŠ” ì œì™¸í•˜ê¸° ìœ„í•´ì„œ
    ruby {
      code => "
        if event.get('ip') && event.get('ip').is_a?(Array)
          ips = event.get('ip').select { |ip| ip.start_with?('10.', '192.') }
          event.set('ip', ips)
        end
      "
    }

    # ì§€ì •ëœ í•„ë“œë§Œ ìœ ì§€í•˜ê³  ë¶ˆí•„ìš”í•œ í•„ë“œëŠ” ëª¨ë‘ ì œê±°
    prune {
      interpolate => true
      whitelist_names => ["@timestamp", "hostname", "login_id", "source_ip", "method", "result", "ip", "status"]
    }

    # ì‹¤íŒ¨ ë©”ì‹œì§€ ì„¤ì •
    mutate {
      add_field => { "message" => "
ðŸ”ž[FAILED] '%{login_id}' failed from %{source_ip} to %{hostname} ([%{ip}])
" }
    }
  }

  # ë¡œê·¸ì¸ì— ì„±ê³µí•œ ë¡œê·¸ì´ë©´---------------------------------------------------------
  else if [auditd][message_type] == "user_login" and [auditd][result] == "success" {
    mutate {
      # ë³µìž¡í•œ í•„ë“œ ì´ë¦„ì„ ê°„ë‹¨í•œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
      rename => {
        "[auditd][message_type]" => "status"
        "[user][name]" => "login_id"
        "[host][name]" => "hostname"
        "[source][ip]" => "source_ip"
        "[auditd][summary][how]" => "method"
        "[auditd][result]" => "result"
        "[host][ip]" => "ip"
        "[auditd][summary][object][primary]" => "tty"
      }
    }

    # ë¡œê·¸ì¸ IDê°€ checkdownì¸ ê²½ìš° ì œê±°
    if [login_id] == "checkdown" {
      drop{}
    }

    # ip í•„ë“œê°€ ë°°ì—´ì¼ ê²½ìš° (10.*, 192.*)ë§Œ í•„í„°ë§ -> ë‹¤ë¥¸ ë¶ˆí•„ìš”í•œ IP ì£¼ì†ŒëŠ” ì œì™¸í•˜ê¸° ìœ„í•´ì„œ
    ruby {
      code => "
        if event.get('ip') && event.get('ip').is_a?(Array)
          ips = event.get('ip').select { |ip| ip.start_with?('10.', '192.') }
          event.set('ip', ips)
        end
      "
    }

    # ttyê°’ì—ì„œ "/"ì œê±° ex) pts/0 => pts0
    ruby {
      code => '
        if event.get("tty")
          parts = event.get("tty").split("/")
          if parts.length > 2
            event.set("tty", parts[-2] + parts[-1])
          end
        end
      '
    }

    # ì§€ì •ëœ í•„ë“œë§Œ ìœ ì§€í•˜ê³  ë¶ˆí•„ìš”í•œ í•„ë“œëŠ” ëª¨ë‘ ì œê±°
    prune {
      interpolate => true
      whitelist_names => ["@timestamp", "hostname", "login_id", "source_ip", "method", "result", "ip", "tty", "status"]
    }

  }

  # vscodeì—ì„œ ì ‘ì†í–ˆì„ ê²½ìš°ë¥¼ ìœ„í•œ ë¡œê·¸---------------------------------------------------------
  else if [auditd][message_type] == "user_start" and [auditd][summary][object][primary] == "ssh" {
    mutate {
      # ë³µìž¡í•œ í•„ë“œ ì´ë¦„ì„ ê°„ë‹¨í•œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
      rename => {
        "[auditd][message_type]" => "status"
        "[user][name]" => "login_id"
        "[host][name]" => "hostname"
        "[source][ip]" => "source_ip"
        "[auditd][summary][how]" => "method"
        "[auditd][result]" => "result"
        "[host][ip]" => "ip"
        "[auditd][summary][object][primary]" => "check_vscode"
      }
    }

    # ë¡œê·¸ì¸ IDê°€ checkdownì¸ ê²½ìš° ì œê±°
    if [login_id] == "checkdown" {
      drop{}
    }

    # ip í•„ë“œê°€ ë°°ì—´ì¼ ê²½ìš° (10.*, 192.*)ë§Œ í•„í„°ë§ -> ë‹¤ë¥¸ ë¶ˆí•„ìš”í•œ IP ì£¼ì†ŒëŠ” ì œì™¸í•˜ê¸° ìœ„í•´ì„œ
    ruby {
      code => "
        if event.get('ip') && event.get('ip').is_a?(Array)
          ips = event.get('ip').select { |ip| ip.start_with?('10.', '192.') }
          event.set('ip', ips)
        end
      "
    }

    # ì§€ì •ëœ í•„ë“œë§Œ ìœ ì§€í•˜ê³  ë¶ˆí•„ìš”í•œ í•„ë“œëŠ” ëª¨ë‘ ì œê±°
    prune {
      interpolate => true
      whitelist_names => ["@timestamp", "hostname", "login_id", "source_ip", "method", "result", "ip", "check_vscode", "status"]
    }
    
    # ì„±ê³µ ë©”ì‹œì§€ ì„¤ì •
    mutate {
      add_field => { "message" => "
âœ…[SUCCESS] '%{login_id}' connected from %{source_ip} to %{hostname} ([%{ip}])
" }
    }
  }

  # ì ‘ì†ì„ ì¢…ë£Œí•œ ë¡œê·¸ì´ë©´---------------------------------------------------------
  else if [auditd][message_type] == "user_end" {
    # ì¢…ë£Œ ë°©ì‹ì´ /usr/bin/sudo ë˜ëŠ” /usr/sbin/sshdê°€ ì•„ë‹Œ ê²½ìš° ë¡œê·¸ ì œê±°
    if [auditd][summary][how] != "/usr/bin/sudo" and [auditd][summary][how] != "/usr/sbin/sshd" {
      drop{}
    } else {
      mutate {
        # ë³µìž¡í•œ í•„ë“œ ì´ë¦„ì„ ê°„ë‹¨í•œ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
        rename => {
          "[auditd][message_type]" => "status"
          "[user][name]" => "logout_id"
          "[host][name]" => "hostname"
          "[auditd][data][hostname]" => "source_ip"
          "[auditd][summary][how]" => "method"
          "[host][ip]" => "ip"
        }
      }

      # ë¡œê·¸ì¸ IDê°€ checkdownì¸ ê²½ìš° ì œê±°
      if [logout_id] == "checkdown" {
        drop{}
      }

      # ip í•„ë“œê°€ ë°°ì—´ì¼ ê²½ìš° (10.*, 192.*)ë§Œ í•„í„°ë§ -> ë‹¤ë¥¸ ë¶ˆí•„ìš”í•œ IP ì£¼ì†ŒëŠ” ì œì™¸í•˜ê¸° ìœ„í•´ì„œ
      ruby {
        code => "
          if event.get('ip') && event.get('ip').is_a?(Array)
            ips = event.get('ip').select { |ip| ip.start_with?('10.', '192.') }
            event.set('ip', ips)
          end
        "
      }

      # ì§€ì •ëœ í•„ë“œë§Œ ìœ ì§€í•˜ê³  ë¶ˆí•„ìš”í•œ í•„ë“œëŠ” ëª¨ë‘ ì œê±°
      prune {
        interpolate => true
        whitelist_names => ["@timestamp", "hostname", "logout_id", "source_ip", "method", "ip", "status"]
      }

    }
  }

  # ê·¸ ì™¸ì— ë¡œê·¸ë“¤ì€ ëª¨ë‘ ì œê±°
  else {
    drop{}
  }
}

output {
  stdout {
    codec => rubydebug
  }

  # Discord Webhookìœ¼ë¡œ ì „ì†¡
  if [status] == "user_start" or [result] == "fail" {
    http {
      url => ""
      http_method => "post"
      content_type => "application/json"
      format => "json"
      headers => ["Content-Type", "application/json"]
      mapping => ["content", "%{message}"]
    }
  }

  # Elasticsearchë¡œ ì „ì†¡
  elasticsearch {
    hosts => ["http://localhost:9200"]
    index => "auditbeat-login-logs-%{+YYYY.MM.dd}"
  }
}

